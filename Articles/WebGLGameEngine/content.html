<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">
        <meta name="viewport" content="width=device-width; target-densityDpi=device-dpi;" />
        
    </head>

    <!--**************-->
    <!-- CSS includes -->
    <!--**************-->
    <link rel="stylesheet" href="../../CSS/Main.css" type="text/css"/>
    <link rel="stylesheet" href="../../CSS/Article.css" type="text/css"/>
    <link rel="stylesheet" href="../../CSS/highlightJS_styles/monokai_sublime.css" type="text/css"/>
    
    <!--*************************-->
    <!-- Shader program includes -->
    <!--*************************-->
    <iframe id="GLSLLibrary" src="../../Shaders/GLSLLibrary.html"></iframe>
    <iframe id="AlphaCutOff" src="../../Shaders/AlphaCutOff.html"></iframe>
    <iframe id="Opaque"      src="../../Shaders/Opaque.html"     ></iframe>
    
    <!--*************-->
    <!-- JS includes -->
    <!--*************-->
    <!--Engine-->
    <script type="text/javascript" src="../../JS/Engine/FunctionExtensions.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Input/Input.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Time/Time.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Graphics/glMatrix-0.9.5.min.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Graphics/Graphics.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Graphics/Material.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Physics/cannon.js"></script>
    <script type="text/javascript" src="../../JS/Engine/Physics/Physics.js"></script>
    <!--src="JS/Engine/Sound/Sound.js"-->
    <script type="text/javascript" src="../../JS/Engine/Application.js"></script>
    <script type="text/javascript" src="../../JS/Engine/GameBase.js"></script>
    <script type="text/javascript" src="../../JS/Engine/ECS/Component.js"></script>
    <script type="text/javascript" src="../../JS/Engine/ECS/Mesh.js"></script>
    <script type="text/javascript" src="../../JS/Engine/ECS/Rigidbody.js"></script>
    <script type="text/javascript" src="../../JS/Engine/ECS/Transform.js"></script>
    <script type="text/javascript" src="../../JS/Engine/ECS/Camera.js"></script>
    <script type="text/javascript" src="../../JS/Engine/ECS/GameObject.js"></script>
    <!--Game-->
    <script type="text/javascript" src="JS/Game/Game.js"></script>
    <!--Game Components-->
    <script type="text/javascript" src="../../JS/Game/Behaviors/Rotator.js"></script>
    <script type="text/javascript" src="../../JS/Game/Behaviors/CameraController.js"></script>
    <!--Prefabs-->
    <script type="text/javascript" src="../../JS/Game/Prefabs/Ground.js"></script>
    <script type="text/javascript" src="../../JS/Game/Prefabs/RotatorTest.js"></script>
    <!--Presentation-->
    <script type="text/javascript" src="../../JS/HighlightJS/highlight.pack.js"></script>
    
    <!--***************-->
    <!-- HTML Document -->
    <!--***************-->
    <title>Joseph Cameron - Game Programmer Portfolio</title>
    
    <body onload="Start();">
        <div id = "background"></div>
        
        <div id = "wrapper">
            <div id="ArticleHeader">WebGL Game Engine</div>
            
            <div id="ArticleHeaderSpacer"></div>
            
            <div class="RatioWrapper">
                <div class="RatioContent">
                    <canvas id="canvas" width="640" height="480"></canvas>
                    
                </div>
            
            </div>
            
            <div id = "header">
                Joseph Cameron | <a href="mailto:jf.cameron@gmail.com">jf.cameron@gmail.com</a>
            
            </div>
        
            <div id = "main">
            
                <h1>Overview</h1>
            
                <p>
                    When I heard about WebGL, I thought it would be a great idea to make something with it for my portfolio. Initially, I wrote the renderer.
                    Forward rendering, 3D. After I had completed the renderer, I decided to add an <a href="https://en.wikipedia.org/wiki/Entity_component_system" target="_blank">Entity Component System</a>
                    to provide a space for game (client) code and an abstraction layer to sit on top of the renderer, I/O manager, Physics engine etc.
                
                </p>
                
                <p>
                    The project as you see it now is made of three parts. A renderer, a physics engine (<a href="http://www.cannonjs.org/">Cannon.js</a>) and an ECS pulling them together.
                
                </p>
                
                <p>
                    Javascript was a very strange language to write in. I wanted to write in an object-oriented manner for a couple of
                    reasons, so after skimming through<a href = "http://addyosmani.com/resources/essentialjsdesignpatterns/book/" target="_blank"> Learning JavaScript Design Patterns</a>
                    I imposed a kind of object-oriented style on my project.

                </p>
                
                <p>    
                    Besides familiarity, I really wanted access to polymorphism for the implementation of the
                    Entity Component System. ECS is a very simple pattern that relies on iterating 2 types: GameObjects and Components. GameObject doesn't need to be derivable;
                    it's essentially a collection of components and a bit of meta information. Components, on the other hand are most easily implemented via polymorphism. Components
                    provide all game functionality within an ECS. Some cruical components will be provided along with the engine, but most will be written by clients writing their own game.
                    In order to provide a common interface to the engine for all these unknown component types, I wanted to define a base type "Component" and have all real components implement this component type.
                    
                </p>
                
                <p>
                    Once the ECS was up and running, I decided to add some physics. I looked around the internet for javascript rigidbody libraries and found
                    <a href="http://www.cannonjs.org/">Cannon.js</a> to be particularly well documented and with a straightforward API.
                
                </p>
                
                <p>
                    So thats it. The ECS provides a place for game logic to be written and simplifies working with the renderer and physics simulation. 
                    Connecting the game logic to the 
                    renderer is the Mesh component, which holds model (VBO, IBO) and material data (Shader program handle, uniform data). 
                    Connecting game logic to the physics simulation is the Rigidbody component. Rigidbody retains a reference to an object within the physics simulation and provides accessors to certain
                    properties of that object. The final basic component is Transform, which holds the model matrix and methods for translation, rotation, scaling.
                
                </p>
                
                <h1>Implementation of the renderer</h1>
               
                <p>
                    Heres an exerpt from the project. If you're interested in looking at the rest, you can download the repo <a href = "https://github.com/jfcameron/WebGLGameEngine" target="_blank">here</a>.
                
                </p>
                
                                <!---------SOURCE----------->
                <p><pre>Graphics.js<code class="js">
//***************************************************************************
// Filename: Graphics.js
// Description: OpenGL graphics engine
// Author: Joseph Cameron
//***************************************************************************
// CHANGELOG
//
// Date: March 1st, 2015
// Description: Initial implementation. Colored triangle rendering.
// Author: Joseph Cameron
//
// Date: March 2nd, 2015
// Description: Texturing added, triangle replaced with quad. Update function added.
// Author: Joseph Cameron
//
// Date: March 3rd, 2015
// Description: getShaderSource method modified to support shader code stored in child html documents (solution for file includes).
// Author: Joseph Cameron
//
// Date: March 5th, 2015
// Description: created Graphics prototype. Beginning to refactor code into something extendible.
//  Added a model matrix (needs to be refactored), added a perspective matrix.
// Author: Joseph Cameron
//
// Date: March 6th, 2015
// Description: removed model matrix. Model matricies now belong to gameobject mesh components.
// Author: Joseph Cameron
//
// Date: March 15th, 2015
// Description: removed update and clear. Clear and update behaviors have been refactored into camera. 
// Author: Joseph Cameron
//
function Graphics()
{
    //*************
    // Data members
    //*************
    //Context data
    var canvas              = null; //Reference to the html element
    var glContext           = null; //Reference to the gl context
    
    //User data
    var clearColor          = [0.535,0.535,0.8,1.0];
    var shaderPrograms      = []; //List of handles to shader programs
    var textures            = []; //List of handles to textures
    var VertexArrays        = []; //List of user defined vertex data
    
    
    //Special VBOs TODO: consider moving to vertexarrays
    var QuadVertexArray     = null; //Reference to the VBO containing Quad vertex data
    var TriVertexArray      = null; //Reference to the VBO containing Triangle vertex data
    var CubeVertexArray     = null;    
    
    //Lighting data
    var m_AmbientLight = [1,1,1,1];
    
    //Camera data, should be refactored to allow for variable # of cameras
    var projectionMatrix    = null;
    var viewMatrix          = null;
    
    //TODO: use this
    var m_ActiveCamera   = null;//test
    this.getActiveCamera = function() {return m_ActiveCamera;};
    this.setActiveCamera = function(aCamera) {m_ActiveCamera = aCamera;};
    
    //**********
    // Accessors
    //**********
    this.getContext            = function(){return glContext      ;};
    
    this.getQuadVertexArray    = function(){return QuadVertexArray;};
    this.getTriVertexArray     = function(){return TriVertexArray;};
    this.getCubeVertexArray    = function(){return CubeVertexArray;};
    
    this.getShaderPrograms     = function(){return shaderPrograms;};
    this.getShader             = function(y){return shaderPrograms.find(function(x){return x.getName() == y ? true : false;})}; 
    
    this.getTextures           = function(){return textures;};
    this.getTexture            = function(y){return textures.find(function(x){return x.getName() == y ? true : false;})};
    
    this.getViewMatrix         = function(){return viewMatrix;};
    this.getProjectionMatrix   = function(){return projectionMatrix;};
    
    //*********
    // Methods
    //*********
    //Initializers  
    this.initopenglContext = function ()
    {
        console.log("Init");
    
        canvas                   = document.getElementById("canvas");
        glContext                = canvas.getContext( "webgl" ); //must be webgl
        glContext.viewportWidth  = canvas.width;
        glContext.viewportHeight = canvas.height;
        
        //glContext.viewport(0,0,canvas.width,canvas.height);
        
    
    };
    
    this.initMatricies = function ()
    {
        //Main camera view matrix
        viewMatrix = mat4.create();
        mat4.identity(viewMatrix);
        mat4.translate(viewMatrix,[0,0,0]);
        mat4.inverse(viewMatrix,viewMatrix);
        
        //Main camera projection matrix
        projectionMatrix = mat4.create();
        mat4.identity(projectionMatrix);
       
        //mat4.ortho(0,10,0,10,-1,1,projectionMatrix);
        mat4.perspective(45, glContext.viewportWidth / glContext.viewportHeight , 0.1, 100.0, projectionMatrix);
        
    };
    
    this.initShader = function (aShaderProgramName) 
    {
        //Create two empty shaders for Vertex/Frag program
        var vertexShader = glContext.createShader( glContext.VERTEX_SHADER   );//glContext.createShader( glContext.VERTEX_SHADER   );
        var fragShader   = glContext.createShader( glContext.FRAGMENT_SHADER ); 
        
        //Compile the shaders
        glContext.shaderSource( vertexShader, this.getShaderSource(aShaderProgramName, "Vertex"));//alphaCutoff_Vert
        glContext.compileShader( vertexShader );
        glContext.shaderSource( fragShader, this.getShaderSource(aShaderProgramName, "Fragment"));//alphaCutoff_Frag
        glContext.compileShader( fragShader); 
        
        //Check for compile errors
        if( !glContext.getShaderParameter( vertexShader, glContext.COMPILE_STATUS) ) 
            alert( glContext.getShaderInfoLog(vertexShader) );
        if( !glContext.getShaderParameter( fragShader, glContext.COMPILE_STATUS) )
            alert( glContext.getShaderInfoLog(fragShader) );
        
        //Create the shader program & compile shaders into graphics programs     
        var shaderProgram = glContext.createProgram();
        shaderProgram.getName = function(){return aShaderProgramName;}; //Passes in name, for later retrieval
        
        glContext.attachShader(shaderProgram, fragShader);
        glContext.attachShader(shaderProgram, vertexShader);
        glContext.linkProgram(shaderProgram);
        
        //add to the list
        shaderPrograms.push(shaderProgram);
        
    };
    
    this.getShaderSource = function (aShaderProgram, id)
    {
        //get lib object
        var shaderLibraryScript = document.getElementById("GLSLLibrary").contentWindow.document.getElementById("Global");
        
        // get shader program doc, sanity check
        var shaderProgramDocument = document.getElementById(aShaderProgram);
        
        if (!shaderProgramDocument)
        {
            alert("Shader program " + aShaderProgram + " could not be found.\nAre you missing a reference?");
            return null;
        }
        
        // get shader source from doc, sanity check
        var shaderScript = document.getElementById(aShaderProgram).contentWindow.document.getElementById(id);
        
        if (!shaderScript)
        {
            alert("Shader " + aShaderProgram + "'s " + id + " shader could not be found.\nIs the object mislabeled?");
            return null;
    
        }
    
        //Convert object text to js string    
        var theSource = "";
        
        //Copy library code into shader source
        var currentChild = shaderLibraryScript.firstChild;
        while(currentChild) 
        {
            if (currentChild.nodeType == 3)
            theSource += currentChild.textContent;
            
            currentChild = currentChild.nextSibling;
            
        }
        
        //Copy shader code into shader source
        var currentChild = shaderScript.firstChild;
        while(currentChild) 
        {
            if (currentChild.nodeType == 3)
            theSource += currentChild.textContent;
            
            currentChild = currentChild.nextSibling;
            
        }
    
        return theSource;
        
    };
    
    this.initializeVertexData = function()
    {
        this.createQuadVertexBuffer();
        this.createTriangleVertexBuffer();
        this.createCubeVertexBuffer();    
        
    };
    
    this.createQuadVertexBuffer = function () 
    {
        //
        // Generate and store quad vertex data
        //
        QuadVertexArray = glContext.createBuffer();
        glContext.bindBuffer( glContext.ARRAY_BUFFER, QuadVertexArray );
        
        var size = 1.0;
        
        var vertices = 
        [
            //          x,               y,    z,   u,   v,  Nx,  Ny,  Nz,
           size -(size/2),  size -(size/2),  0.0, 1.0, 0.0, 0.0, 0.0, 1.0, // 1--0
           0.0  -(size/2),  size -(size/2),  0.0, 0.0, 0.0, 0.0, 0.0, 1.0, // | /
           0.0  -(size/2),  0.0  -(size/2),  0.0, 0.0, 1.0, 0.0, 0.0, 1.0, // 2
                                            
           size -(size/2),  size -(size/2),  0.0, 1.0, 0.0, 0.0, 0.0, 1.0, //    0
           0.0  -(size/2),  0.0  -(size/2),  0.0, 0.0, 1.0, 0.0, 0.0, 1.0, //  / |
           size -(size/2),  0.0  -(size/2),  0.0, 1.0, 1.0, 0.0, 0.0, 1.0, // 1--2
            
        ];
        
        glContext.bufferData( glContext.ARRAY_BUFFER, new Float32Array(vertices), glContext.STATIC_DRAW );
        QuadVertexArray.itemSize = 8;
        QuadVertexArray.numItems = 6;
        
        //
        // Clean up. Its a state machine. Go back to null.
        //
        glContext.bindBuffer( glContext.ARRAY_BUFFER,null);

    };
    
    this.createTriangleVertexBuffer = function () 
    {
        //
        // Generate and store quad vertex data
        //
        TriVertexArray = glContext.createBuffer();
        glContext.bindBuffer( glContext.ARRAY_BUFFER, TriVertexArray );
        
        var size = 1.0;
        
        var vertices = 
        [
            //          x,               y,    z,   u,   v,  Nx,  Ny,  Nz,
           size -(size/2),  size -(size/2),  0.0, 1.0, 0.0, 0.0, 0.0, 0.0, // 1--0
           0.0  -(size/2),  size -(size/2),  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, // | /
           0.0  -(size/2),  0.0  -(size/2),  0.0, 0.0, 1.0, 0.0, 0.0, 0.0, // 2
            
        ];
        
        glContext.bufferData( glContext.ARRAY_BUFFER, new Float32Array(vertices), glContext.STATIC_DRAW );
        TriVertexArray.itemSize = 8;
        TriVertexArray.numItems = 3;
        
        //
        // Clean up. Its a state machine. Go back to null.
        //
        glContext.bindBuffer( glContext.ARRAY_BUFFER,null);

    };
    
    this.createCubeVertexBuffer = function () 
    {
        //
        // Generate and store quad vertex data
        //
        CubeVertexArray = glContext.createBuffer();
        glContext.bindBuffer( glContext.ARRAY_BUFFER, CubeVertexArray );
        
        var size = 1.0;
        
        var vertices = 
        [
           //North
           //           x,               y,        z,   u,   v,  Nx,  Ny,   Nz,
           size -(size/2),  size -(size/2),  -size/2, 0.0, 0.0, 0.0, 0.0, -1.0, // 2--0
           0.0  -(size/2),  0.0  -(size/2),  -size/2, 1.0, 1.0, 0.0, 0.0, -1.0, // | /
           0.0  -(size/2),  size -(size/2),  -size/2, 1.0, 0.0, 0.0, 0.0, -1.0, // 1
                            
           size -(size/2),  size -(size/2),  -size/2, 0.0, 0.0, 0.0, 0.0, -1.0, //    0
           size -(size/2),  0.0  -(size/2),  -size/2, 0.0, 1.0, 0.0, 0.0, -1.0, //  / |
           0.0  -(size/2),  0.0  -(size/2),  -size/2, 1.0, 1.0, 0.0, 0.0, -1.0, // 2--1
           
           //South
           //           x,               y,        z,   u,   v,   Nx,  Ny,   Nz,
           size -(size/2),  size -(size/2),   size/2, 1.0, 0.0,  0.0, 0.0, +1.0, // 1--0
           0.0  -(size/2),  size -(size/2),   size/2, 0.0, 0.0,  0.0, 0.0, +1.0, // | /
           0.0  -(size/2),  0.0  -(size/2),   size/2, 0.0, 1.0,  0.0, 0.0, +1.0, // 2
                                            
           size -(size/2),  size -(size/2),   size/2, 1.0, 0.0,  0.0, 0.0, +1.0, //    0
           0.0  -(size/2),  0.0  -(size/2),   size/2, 0.0, 1.0,  0.0, 0.0, +1.0, //  / |
           size -(size/2),  0.0  -(size/2),   size/2, 1.0, 1.0,  0.0, 0.0, +1.0, // 1--2
           
           //West
           //           x,              y,         z,   u,   v,   Nx,  Ny,  Nz,
           0.0  -(size/2), size -(size/2),    size/2, 1.0, 0.0, -1.0, 0.0, 0.0, // 2--0
           0.0  -(size/2), size -(size/2),   -size/2, 0.0, 0.0, -1.0, 0.0, 0.0, // | /
           0.0  -(size/2), 0.0  -(size/2),   -size/2, 0.0, 1.0, -1.0, 0.0, 0.0, // 1
                      
           0.0 -(size/2),  size -(size/2),    size/2, 1.0, 0.0, -1.0, 0.0, 0.0, //    0
           0.0 -(size/2),  0.0  -(size/2),   -size/2, 0.0, 1.0, -1.0, 0.0, 0.0, //  / |
           0.0 -(size/2),  0.0  -(size/2),    size/2, 1.0, 1.0, -1.0, 0.0, 0.0, // 2--1
           
           //East
           //           x,               y,        z,   u,   v,   Nx,   Ny,  Nz,
           size -(size/2),  size -(size/2),   size/2, 0.0, 0.0, +1.0,  0.0, 0.0, // 2--0
           size -(size/2),  0.0  -(size/2),  -size/2, 1.0, 1.0, +1.0,  0.0, 0.0, // | /
           size -(size/2),  size -(size/2),  -size/2, 1.0, 0.0, +1.0,  0.0, 0.0, // 1
                                                                       
           size -(size/2),  size -(size/2),   size/2, 0.0, 0.0, +1.0,  0.0, 0.0, //    0
           size -(size/2),  0.0  -(size/2),   size/2, 0.0, 1.0, +1.0,  0.0, 0.0, //  / |
           size -(size/2),  0.0  -(size/2),  -size/2, 1.0, 1.0, +1.0,  0.0, 0.0, // 2--1
           
           //Down
           //           x,              y,         z,   u,   v,   Nx,  Ny,  Nz,
           size -(size/2),  0.0 -(size/2),   -size/2, 1.0, 0.0,  0.0, -1.0, 0.0, // 2--0
           0.0  -(size/2),  0.0 -(size/2),    size/2, 0.0, 1.0,  0.0, -1.0, 0.0, // | /
           0.0  -(size/2),  0.0 -(size/2),   -size/2, 0.0, 0.0,  0.0, -1.0, 0.0, // 1
                                            
           size -(size/2),  0.0  -(size/2),  -size/2, 1.0, 0.0,  0.0, -1.0, 0.0, //    0
           size -(size/2),  0.0  -(size/2),   size/2, 1.0, 1.0,  0.0, -1.0, 0.0, //  / |
           0.0  -(size/2),  0.0  -(size/2),   size/2, 0.0, 1.0,  0.0, -1.0, 0.0, // 2--1
           
           //Up
           //           x,               y,       z,   u,   v,    Nx,   Ny,  Nz,
           size -(size/2),  1.0  -(size/2), -size/2, 1.0, 0.0,   0.0, +1.0, 0.0, // 1--0
           0.0  -(size/2),  1.0  -(size/2), -size/2, 0.0, 0.0,   0.0, +1.0, 0.0, // | /
           0.0  -(size/2),  1.0  -(size/2),  size/2, 0.0, 1.0,   0.0, +1.0, 0.0, // 2
                                                                       
           size -(size/2),  1.0  -(size/2), -size/2, 1.0, 0.0,   0.0, +1.0, 0.0, //    0
           0.0  -(size/2),  1.0  -(size/2),  size/2, 0.0, 1.0,   0.0, +1.0, 0.0, //  / |
           size -(size/2),  1.0  -(size/2),  size/2, 1.0, 1.0,   0.0, +1.0, 0.0, // 1--2
            
        ];
        
        glContext.bufferData( glContext.ARRAY_BUFFER, new Float32Array(vertices), glContext.STATIC_DRAW );
        CubeVertexArray.itemSize =  8;
        CubeVertexArray.numItems = 36;
        
        //
        // Clean up. Its a state machine. Go back to null.
        //
        glContext.bindBuffer( glContext.ARRAY_BUFFER,null);

    };
    
    handleTextureLoaded = function (image, texture)  //TODO: simplify. User should specify callback via parameter on loadText call
    {
    
        glContext.bindTexture(glContext.TEXTURE_2D, texture);
        glContext.texImage2D(glContext.TEXTURE_2D, 0, glContext.RGBA, glContext.RGBA,glContext.UNSIGNED_BYTE, image);
        glContext.texParameteri(glContext.TEXTURE_2D, glContext.TEXTURE_MAG_FILTER, glContext.GL_NEAREST);
        glContext.texParameteri(glContext.TEXTURE_2D, glContext.TEXTURE_MIN_FILTER, glContext.GL_NEAREST);
        glContext.generateMipmap(glContext.TEXTURE_2D);
        glContext.bindTexture(glContext.TEXTURE_2D, null);
        
        console.log(texture.getName());
    
    };
    
    this.loadTexture = function(aTexturePath)
    {
        var texture = glContext.createTexture();
        {
            var image = new Image();
            image.onload = function() { handleTextureLoaded(image, texture); }
            image.src = "textures/"+aTexturePath;
            texture.getName = function(){return aTexturePath.toString();};
            
        }
        
        textures.push(texture);
        
    };
    
    this.initTextures = function () 
    {
        this.loadTexture("awesome.png");
        this.loadTexture("brick.png");
        this.loadTexture("grass.png");
        
    
    };
    
    this.initShaderPrograms = function ()
    {
        this.initShader("AlphaCutOff");
        this.initShader("Opaque");
    
    };
        
    //Program entry and update
    this.start = function ()
    {
        this.initopenglContext();
        this.initShaderPrograms();
        this.initializeVertexData();
        this.initTextures();
        this.initMatricies();
        
        glContext.clearColor(clearColor[0],clearColor[1],clearColor[2],clearColor[3]);
        
    };
    
}
                </code></pre></p>
                <!----------END OF SOURCE------------>
                
            </div>
            
            <div id = "footer">
                Joseph Cameron | <a href="">jf.cameron@gmail.com</a>
            
            </div>
            
        </div>
     
        <script type="text/javascript" src="../../JS/Presentation/StagingLabel.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
                
    </body>
    
</html>






